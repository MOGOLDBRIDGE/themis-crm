<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Themis CRM</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/mammoth@1.6.0/mammoth.browser.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #1a1a1a; }
        .app { display: flex; min-height: 100vh; }
        .sidebar { width: 240px; background: #fff; border-right: 1px solid #e0e0e0; padding: 20px 0; position: fixed; height: 100vh; overflow-y: auto; }
        .logo { font-size: 24px; font-weight: 700; padding: 0 20px 30px; }
        .logo span { color: #FFDF48; }
        .nav-section { font-size: 11px; font-weight: 600; color: #888; padding: 20px 20px 10px; text-transform: uppercase; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 20px; cursor: pointer; font-size: 14px; color: #555; border: none; background: none; width: 100%; text-align: left; }
        .nav-item:hover { background: #f5f5f5; }
        .nav-item.active { background: #FFDF48; font-weight: 600; color: #000; }
        .main { flex: 1; margin-left: 240px; }
        .topbar { background: #fff; padding: 20px 30px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .topbar h1 { font-size: 22px; font-weight: 600; }
        .content { padding: 30px; }
        .btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: #FFDF48; color: #000; }
        .btn-primary:hover { background: #f0d000; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .btn-secondary:hover { background: #e5e5e5; }
        .btn-sm { padding: 6px 14px; font-size: 13px; }
        .btn-danger { background: #fee; color: #c00; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 20px; }
        .card { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
        .card:hover { border-color: #FFDF48; box-shadow: 0 4px 20px rgba(0,0,0,0.08); transform: translateY(-2px); }
        .card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .card-title { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
        .card-subtitle { font-size: 13px; color: #666; }
        .card-row { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; margin-bottom: 8px; }
        .tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 12px; }
        .tag { padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background: #f0f0f0; color: #444; cursor: pointer; transition: all 0.15s; }
        .tag:hover { background: #e0e0e0; }
        .tag-primary { background: #FFDF48; color: #000; }
        .tag-contract { background: #e8f4ff; color: #0066cc; }
        .tag-perm { background: #f0e8ff; color: #6600cc; }
        .tag-skill { background: #e8fff0; color: #00804d; }
        .rate-box { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #f8f8f8; border-radius: 8px; font-size: 14px; font-weight: 600; }
        .rate-box.contract { background: #e8f4ff; color: #0066cc; }
        .rate-box.perm { background: #f0e8ff; color: #6600cc; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal { background: #fff; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-lg { max-width: 800px; }
        .modal-header { padding: 20px 25px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 28px; cursor: pointer; color: #888; line-height: 1; }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 20px 25px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #333; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 14px; border: 1.5px solid #e0e0e0; border-radius: 10px; font-size: 14px; transition: all 0.15s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #FFDF48; box-shadow: 0 0 0 4px rgba(255,223,72,0.15); }
        .form-textarea { min-height: 100px; resize: vertical; font-family: inherit; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .detail-panel { position: fixed; top: 0; right: 0; width: 550px; height: 100vh; background: #fff; border-left: 1px solid #e0e0e0; z-index: 500; display: flex; flex-direction: column; box-shadow: -10px 0 40px rgba(0,0,0,0.1); }
        .detail-header { padding: 25px; border-bottom: 1px solid #e0e0e0; }
        .detail-body { flex: 1; overflow-y: auto; padding: 25px; }
        .detail-section { margin-bottom: 30px; }
        .detail-section-title { font-size: 12px; font-weight: 600; color: #888; text-transform: uppercase; margin-bottom: 12px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-item { }
        .info-label { font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        .info-value { font-size: 14px; font-weight: 500; }
        .toolbar { display: flex; gap: 12px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .search-box { position: relative; flex: 1; min-width: 250px; }
        .search-input { width: 100%; padding: 12px 16px 12px 44px; border: 1.5px solid #e0e0e0; border-radius: 10px; font-size: 14px; background: #fff; }
        .search-input:focus { outline: none; border-color: #FFDF48; }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: #888; }
        .filter-group { display: flex; gap: 8px; }
        .filter-btn { padding: 10px 16px; border: 1.5px solid #e0e0e0; border-radius: 10px; font-size: 13px; font-weight: 500; cursor: pointer; background: #fff; transition: all 0.15s; }
        .filter-btn:hover { border-color: #ccc; }
        .filter-btn.active { background: #FFDF48; border-color: #FFDF48; }
        .empty { text-align: center; padding: 80px 40px; }
        .empty-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-title { font-size: 20px; font-weight: 600; margin-bottom: 10px; }
        .empty-text { color: #666; margin-bottom: 25px; }
        .dropzone { border: 2px dashed #d0d0d0; border-radius: 16px; padding: 50px 30px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; }
        .dropzone:hover, .dropzone.active { border-color: #FFDF48; background: #fffdf0; }
        .dropzone-icon { font-size: 56px; margin-bottom: 15px; }
        .dropzone-text { font-size: 17px; font-weight: 500; margin-bottom: 8px; }
        .dropzone-hint { font-size: 13px; color: #888; }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 12px; padding: 20px; }
        .kpi-card.highlight { background: linear-gradient(135deg, #fffef0, #fff); border-color: #FFDF48; }
        .kpi-value { font-size: 36px; font-weight: 700; margin-bottom: 5px; }
        .kpi-label { font-size: 13px; color: #666; }
        .kpi-sub { font-size: 12px; color: #00aa00; margin-top: 8px; }
        .timeline { margin-top: 15px; }
        .timeline-item { position: relative; padding-left: 25px; padding-bottom: 20px; border-left: 2px solid #e0e0e0; }
        .timeline-item:last-child { border-left-color: transparent; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 2px; width: 10px; height: 10px; border-radius: 50%; background: #FFDF48; border: 2px solid #fff; }
        .timeline-date { font-size: 12px; color: #888; margin-bottom: 4px; }
        .timeline-content { font-size: 14px; }
        .pipeline { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; }
        .pipeline-col { min-width: 300px; background: #fff; border-radius: 12px; padding: 15px; border: 1px solid #e0e0e0; transition: background 0.2s; }
        .pipeline-col.drag-over { background: #fffef0; border-color: #FFDF48; }
        .pipeline-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid #f0f0f0; }
        .pipeline-title { font-weight: 600; font-size: 14px; }
        .pipeline-count { background: #FFDF48; padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .pipeline-card { background: #fafafa; border: 1px solid #e8e8e8; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: grab; transition: all 0.15s; }
        .pipeline-card:hover { background: #fff; border-color: #FFDF48; }
        .pipeline-card.dragging { opacity: 0.5; cursor: grabbing; }
        .pipeline-card.green { border-left: 4px solid #00cc66; }
        .pipeline-card.amber { border-left: 4px solid #ffaa00; }
        .pipeline-card.red { border-left: 4px solid #ff4444; }
        .pipeline-card-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .pipeline-card-sub { font-size: 12px; color: #666; margin-bottom: 8px; }
        .pipeline-card-meta { display: flex; justify-content: space-between; font-size: 12px; }
        .margin-good { color: #00aa00; font-weight: 600; }
        .margin-ok { color: #cc8800; font-weight: 600; }
        .margin-low { color: #cc0000; font-weight: 600; }
        .skill-input-wrap { position: relative; }
        .skill-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #e0e0e0; border-radius: 10px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-height: 250px; overflow-y: auto; z-index: 100; margin-top: 5px; }
        .skill-suggestion { padding: 12px 15px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f0f0f0; }
        .skill-suggestion:hover { background: #f5f5f5; }
        .skill-suggestion:last-child { border-bottom: none; }
        .selected-skills { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .selected-skill { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: #e8fff0; color: #00804d; border-radius: 8px; font-size: 13px; font-weight: 500; }
        .selected-skill button { background: none; border: none; cursor: pointer; font-size: 16px; line-height: 1; color: #00804d; opacity: 0.6; }
        .selected-skill button:hover { opacity: 1; }
        .cv-file { display: flex; align-items: center; gap: 12px; padding: 15px; background: #f8f8f8; border-radius: 10px; margin-top: 15px; }
        .cv-file-icon { font-size: 32px; }
        .cv-file-info { flex: 1; }
        .cv-file-name { font-weight: 600; font-size: 14px; }
        .cv-file-size { font-size: 12px; color: #888; }
        .tag-filter-section { margin-bottom: 25px; }
        .tag-filter-title { font-size: 12px; font-weight: 600; color: #888; margin-bottom: 10px; text-transform: uppercase; }
        .tag-filters { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-filter { padding: 8px 14px; border-radius: 8px; font-size: 13px; font-weight: 500; background: #fff; border: 1.5px solid #e0e0e0; cursor: pointer; transition: all 0.15s; }
        .tag-filter:hover { border-color: #FFDF48; }
        .tag-filter.active { background: #FFDF48; border-color: #FFDF48; }
        .tag-filter .count { margin-left: 6px; opacity: 0.6; }
        .notification { position: fixed; top: 20px; right: 20px; background: #1a1a1a; color: #fff; padding: 15px 25px; border-radius: 10px; z-index: 9999; font-size: 14px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;

if (window.pdfjsLib) {
    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

const SKILL_TAXONOMY = {
    'SAP': ['SAP FICO', 'SAP MM', 'SAP SD', 'SAP PP', 'SAP ABAP', 'SAP BW', 'SAP HANA', 'SAP S/4HANA', 'SAP SuccessFactors', 'SAP Ariba', 'SAP Basis', 'SAP Security', 'SAP Fiori'],
    'AWS': ['AWS Solutions Architect', 'AWS Developer', 'AWS DevOps', 'AWS EC2', 'AWS S3', 'AWS Lambda', 'AWS RDS', 'AWS CloudFormation', 'AWS ECS', 'AWS EKS'],
    'Azure': ['Azure Solutions Architect', 'Azure Developer', 'Azure DevOps', 'Azure Functions', 'Azure SQL', 'Azure Kubernetes Service', 'Power BI', 'Power Apps'],
    'Java': ['Java SE', 'Java EE', 'Spring Boot', 'Spring MVC', 'Hibernate', 'Maven', 'Microservices', 'REST API'],
    '.NET': ['C#', '.NET Core', 'ASP.NET', 'Entity Framework', 'Blazor', 'WPF'],
    'JavaScript': ['JavaScript', 'TypeScript', 'React', 'Angular', 'Vue.js', 'Node.js', 'Express.js', 'Next.js'],
    'Python': ['Python', 'Django', 'Flask', 'FastAPI', 'Pandas', 'TensorFlow', 'PyTorch'],
    'DevOps': ['Docker', 'Kubernetes', 'Terraform', 'Jenkins', 'GitLab CI', 'GitHub Actions', 'Ansible'],
    'Data': ['SQL', 'PostgreSQL', 'MongoDB', 'Redis', 'Snowflake', 'Apache Spark', 'ETL'],
    'Cloud': ['GCP', 'Oracle Cloud', 'IBM Cloud', 'Multi-Cloud'],
    'Other': ['Agile', 'Scrum', 'Project Management', 'Business Analysis', 'Solution Architecture']
};

const ALL_SKILLS = Object.entries(SKILL_TAXONOMY).flatMap(([cat, skills]) => skills.map(s => ({ skill: s, category: cat })));

const store = {
    get: (key) => { try { return JSON.parse(localStorage.getItem('themis:' + key)); } catch(e) { return null; } },
    set: (key, val) => { localStorage.setItem('themis:' + key, JSON.stringify(val)); },
    list: (prefix) => {
        const items = [];
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (k.startsWith('themis:' + prefix)) {
                try { items.push(JSON.parse(localStorage.getItem(k))); } catch(e) {}
            }
        }
        return items.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
    },
    delete: (key) => { localStorage.removeItem('themis:' + key); }
};

const parseCV = async (file) => {
    const result = { name: '', email: '', phone: '', location: '', skills: [], fileName: file.name, fileSize: file.size };
    try {
        let text = '';
        if (file.type === 'application/pdf') {
            const ab = await file.arrayBuffer();
            const pdf = await window.pdfjsLib.getDocument({ data: ab }).promise;
            for (let i = 1; i <= Math.min(pdf.numPages, 5); i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(' ') + '\n';
            }
        } else if (file.name.endsWith('.docx')) {
            const ab = await file.arrayBuffer();
            const doc = await mammoth.extractRawText({ arrayBuffer: ab });
            text = doc.value;
        } else {
            text = await file.text();
        }
        const emailMatch = text.match(/[\w.-]+@[\w.-]+\.\w+/);
        if (emailMatch) result.email = emailMatch[0].toLowerCase();
        const phoneMatch = text.match(/(?:\+44|0)[\d\s()-]{9,}/);
        if (phoneMatch) result.phone = phoneMatch[0].trim();
        const lines = text.split('\n').filter(l => l.trim().length > 2);
        if (lines[0] && lines[0].length < 50 && !lines[0].includes('@')) result.name = lines[0].trim();
        const cities = ['London', 'Manchester', 'Birmingham', 'Leeds', 'Glasgow', 'Bristol', 'Edinburgh', 'Cardiff', 'Newcastle'];
        for (const city of cities) { if (text.toLowerCase().includes(city.toLowerCase())) { result.location = city; break; } }
        const lowerText = text.toLowerCase();
        for (const { skill } of ALL_SKILLS) { if (lowerText.includes(skill.toLowerCase())) result.skills.push(skill); }
        result.skills = [...new Set(result.skills)].slice(0, 15);
    } catch (e) { console.error(e); }
    return result;
};

function App() {
    const [view, setView] = useState('dashboard');
    const [candidates, setCandidates] = useState([]);
    const [clients, setClients] = useState([]);
    const [contacts, setContacts] = useState([]);
    const [jobs, setJobs] = useState([]);
    const [submissions, setSubmissions] = useState([]);
    const [activities, setActivities] = useState([]);
    const [modal, setModal] = useState(null);
    const [editItem, setEditItem] = useState(null);
    const [detailItem, setDetailItem] = useState(null);
    const [search, setSearch] = useState('');
    const [notify, setNotify] = useState(null);
    const [filterType, setFilterType] = useState('all');
    const [filterSkills, setFilterSkills] = useState([]);

    useEffect(() => { loadAll(); checkUrl(); }, []);

    const loadAll = () => {
        setCandidates(store.list('candidate:'));
        setClients(store.list('client:'));
        setContacts(store.list('contact:'));
        setJobs(store.list('job:'));
        setSubmissions(store.list('submission:'));
        setActivities(store.list('activity:'));
    };

    const checkUrl = () => {
        const params = new URLSearchParams(window.location.search);
        const data = params.get('addCandidate');
        if (data) {
            try {
                const c = JSON.parse(decodeURIComponent(data));
                const exists = store.list('candidate:').some(x => x.linkedin === c.linkedin || x.email === c.email);
                if (!exists && c.name) {
                    const id = c.id || Date.now().toString();
                    store.set('candidate:' + id, { ...c, id, type: 'contract', skills: [], createdAt: new Date().toISOString() });
                    showNotify('‚úì Added: ' + c.name);
                    loadAll();
                }
                window.history.replaceState({}, '', window.location.pathname);
            } catch(e) {}
        }
    };

    const showNotify = (msg) => { setNotify(msg); setTimeout(() => setNotify(null), 3000); };

    const saveEntity = (type, data) => {
        const id = editItem?.id || Date.now().toString();
        const item = { ...editItem, ...data, id, updatedAt: new Date().toISOString(), createdAt: editItem?.createdAt || new Date().toISOString() };
        store.set(type + ':' + id, item);
        loadAll(); setModal(null); setEditItem(null); showNotify('‚úì Saved');
    };

    const deleteEntity = (type, id) => {
        if (confirm('Delete?')) { store.delete(type + ':' + id); loadAll(); setDetailItem(null); showNotify('Deleted'); }
    };

    const saveSubmission = (data) => {
        const id = editItem?.id || Date.now().toString();
        const margin = data.chargeRate && data.payRate ? (((parseFloat(data.chargeRate) - parseFloat(data.payRate)) / parseFloat(data.chargeRate)) * 100).toFixed(1) : 0;
        const item = { ...editItem, ...data, id, margin, stage: editItem?.stage || 'Sourced', history: editItem?.history || [{ stage: 'Sourced', date: new Date().toISOString() }], createdAt: editItem?.createdAt || new Date().toISOString() };
        store.set('submission:' + id, item);
        loadAll(); setModal(null); setEditItem(null); showNotify('‚úì Saved');
    };

    const updateStage = (id, stage) => {
        const sub = submissions.find(s => s.id === id);
        if (sub) {
            sub.stage = stage;
            sub.history = [...(sub.history || []), { stage, date: new Date().toISOString() }];
            store.set('submission:' + id, sub);
            loadAll();
        }
    };

    const nav = [
        { section: 'Core' },
        { id: 'dashboard', icon: 'üìä', label: 'Dashboard' },
        { id: 'candidates', icon: 'üë§', label: 'Candidates' },
        { id: 'jobs', icon: 'üíº', label: 'Jobs' },
        { id: 'pipeline', icon: 'üéØ', label: 'Pipeline' },
        { section: 'Business Dev' },
        { id: 'clients', icon: 'üè¢', label: 'Clients' },
        { id: 'contacts', icon: 'üìá', label: 'Contacts' },
        { section: 'Activity' },
        { id: 'activities', icon: 'üìù', label: 'Activity Log' },
    ];

    return (
        <div className="app">
            {notify && <div className="notification">{notify}</div>}
            <div className="sidebar">
                <div className="logo">Themis <span>CRM</span></div>
                {nav.map((n, i) => n.section ? <div key={i} className="nav-section">{n.section}</div> : (
                    <button key={n.id} className={`nav-item ${view === n.id ? 'active' : ''}`} onClick={() => { setView(n.id); setDetailItem(null); }}>
                        <span>{n.icon}</span> {n.label}
                    </button>
                ))}
            </div>
            <div className="main">
                {view === 'dashboard' && <Dashboard candidates={candidates} jobs={jobs} submissions={submissions} activities={activities} clients={clients} onNav={setView} />}
                {view === 'candidates' && <Candidates candidates={candidates} search={search} setSearch={setSearch} filterType={filterType} setFilterType={setFilterType} filterSkills={filterSkills} setFilterSkills={setFilterSkills} onAdd={() => { setEditItem(null); setModal('candidate'); }} onUpload={() => setModal('upload')} onSelect={c => setDetailItem({ type: 'candidate', data: c })} />}
                {view === 'jobs' && <Jobs jobs={jobs} clients={clients} search={search} setSearch={setSearch} onAdd={() => { setEditItem(null); setModal('job'); }} onSelect={j => setDetailItem({ type: 'job', data: j })} />}
                {view === 'pipeline' && <Pipeline submissions={submissions} candidates={candidates} jobs={jobs} clients={clients} onUpdateStage={updateStage} onAdd={() => setModal('submission')} />}
                {view === 'clients' && <Clients clients={clients} search={search} setSearch={setSearch} onAdd={() => { setEditItem(null); setModal('client'); }} onEdit={c => { setEditItem(c); setModal('client'); }} />}
                {view === 'contacts' && <Contacts contacts={contacts} clients={clients} search={search} setSearch={setSearch} onAdd={() => { setEditItem(null); setModal('contact'); }} onEdit={c => { setEditItem(c); setModal('contact'); }} />}
                {view === 'activities' && <Activities activities={activities} candidates={candidates} contacts={contacts} jobs={jobs} onAdd={() => setModal('activity')} />}
            </div>
            {detailItem?.type === 'candidate' && <CandidateDetail candidate={detailItem.data} activities={activities.filter(a => a.relatedId === detailItem.data.id)} submissions={submissions.filter(s => s.candidateId === detailItem.data.id)} jobs={jobs} clients={clients} onClose={() => setDetailItem(null)} onEdit={() => { setEditItem(detailItem.data); setModal('candidate'); }} onDelete={() => deleteEntity('candidate', detailItem.data.id)} onAddActivity={() => { setEditItem({ relatedType: 'candidate', relatedId: detailItem.data.id }); setModal('activity'); }} onAddSubmission={() => { setEditItem({ candidateId: detailItem.data.id }); setModal('submission'); }} />}
            {detailItem?.type === 'job' && <JobDetail job={detailItem.data} client={clients.find(c => c.id === detailItem.data.clientId)} submissions={submissions.filter(s => s.jobId === detailItem.data.id)} candidates={candidates} onClose={() => setDetailItem(null)} onEdit={() => { setEditItem(detailItem.data); setModal('job'); }} onDelete={() => deleteEntity('job', detailItem.data.id)} onAddSubmission={() => { setEditItem({ jobId: detailItem.data.id }); setModal('submission'); }} />}
            {modal === 'candidate' && <CandidateModal item={editItem} onClose={() => { setModal(null); setEditItem(null); }} onSave={d => saveEntity('candidate', d)} />}
            {modal === 'upload' && <UploadModal onClose={() => setModal(null)} onSave={d => saveEntity('candidate', d)} />}
            {modal === 'job' && <JobModal item={editItem} clients={clients} onClose={() => { setModal(null); setEditItem(null); }} onSave={d => saveEntity('job', { ...d, status: d.status || 'Open' })} />}
            {modal === 'client' && <ClientModal item={editItem} onClose={() => { setModal(null); setEditItem(null); }} onSave={d => saveEntity('client', d)} />}
            {modal === 'contact' && <ContactModal item={editItem} clients={clients} onClose={() => { setModal(null); setEditItem(null); }} onSave={d => saveEntity('contact', d)} />}
            {modal === 'submission' && <SubmissionModal item={editItem} candidates={candidates} jobs={jobs} onClose={() => { setModal(null); setEditItem(null); }} onSave={saveSubmission} />}
            {modal === 'activity' && <ActivityModal item={editItem} candidates={candidates} contacts={contacts} jobs={jobs} onClose={() => { setModal(null); setEditItem(null); }} onSave={d => { store.set('activity:' + Date.now(), { ...d, id: Date.now().toString(), createdAt: new Date().toISOString() }); loadAll(); setModal(null); setEditItem(null); showNotify('‚úì Logged'); }} />}
        </div>
    );
}

function Dashboard({ candidates, jobs, submissions, activities, clients, onNav }) {
    const today = new Date().toDateString();
    const week = Date.now() - 7*24*60*60*1000;
    const stats = { candidates: candidates.length, newCands: candidates.filter(c => new Date(c.createdAt) > week).length, clients: clients.length, openJobs: jobs.filter(j => j.status !== 'Closed').length, pipeline: submissions.filter(s => !['Placed','Rejected'].includes(s.stage)).length, placements: submissions.filter(s => s.stage === 'Placed').length, todayActs: activities.filter(a => new Date(a.createdAt).toDateString() === today).length };
    const cvToInt = submissions.length ? Math.round((submissions.filter(s => ['1st Interview','2nd Interview','Offer','Placed'].includes(s.stage)).length / submissions.length) * 100) : 0;
    return (
        <>
            <div className="topbar"><h1>Dashboard</h1></div>
            <div className="content">
                <div className="kpi-grid">
                    <div className="kpi-card highlight" onClick={() => onNav('candidates')} style={{cursor:'pointer'}}><div className="kpi-value">{stats.candidates}</div><div className="kpi-label">Candidates</div>{stats.newCands > 0 && <div className="kpi-sub">+{stats.newCands} this week</div>}</div>
                    <div className="kpi-card" onClick={() => onNav('clients')} style={{cursor:'pointer'}}><div className="kpi-value">{stats.clients}</div><div className="kpi-label">Clients</div></div>
                    <div className="kpi-card" onClick={() => onNav('jobs')} style={{cursor:'pointer'}}><div className="kpi-value">{stats.openJobs}</div><div className="kpi-label">Open Jobs</div></div>
                    <div className="kpi-card" onClick={() => onNav('pipeline')} style={{cursor:'pointer'}}><div className="kpi-value">{stats.pipeline}</div><div className="kpi-label">In Pipeline</div></div>
                    <div className="kpi-card highlight"><div className="kpi-value">{stats.placements}</div><div className="kpi-label">Placements</div></div>
                    <div className="kpi-card"><div className="kpi-value">{cvToInt}%</div><div className="kpi-label">CV‚ÜíInterview</div></div>
                </div>
                <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'20px'}}>
                    <div className="card" style={{cursor:'default'}}><h3 style={{marginBottom:'15px'}}>Recent Candidates</h3>{candidates.slice(0,5).map(c => <div key={c.id} style={{padding:'10px 0',borderBottom:'1px solid #f0f0f0'}}><strong>{c.name}</strong><div style={{fontSize:'12px',color:'#888'}}>{Array.isArray(c.skills) ? c.skills.slice(0,2).join(', ') : ''}</div></div>)}{candidates.length === 0 && <div style={{color:'#888'}}>No candidates</div>}</div>
                    <div className="card" style={{cursor:'default'}}><h3 style={{marginBottom:'15px'}}>Today's Activity ({stats.todayActs})</h3>{activities.filter(a => new Date(a.createdAt).toDateString() === today).slice(0,5).map(a => <div key={a.id} style={{padding:'10px 0',borderBottom:'1px solid #f0f0f0'}}><strong>{a.type}</strong></div>)}{stats.todayActs === 0 && <div style={{color:'#888'}}>No activity today</div>}</div>
                </div>
            </div>
        </>
    );
}

function Candidates({ candidates, search, setSearch, filterType, setFilterType, filterSkills, setFilterSkills, onAdd, onUpload, onSelect }) {
    const allSkills = {};
    candidates.forEach(c => { if (Array.isArray(c.skills)) c.skills.forEach(s => { allSkills[s] = (allSkills[s]||0)+1; }); });
    const topSkills = Object.entries(allSkills).sort((a,b) => b[1]-a[1]).slice(0,12);
    let filtered = candidates;
    if (filterType !== 'all') filtered = filtered.filter(c => c.type === filterType);
    if (filterSkills.length) filtered = filtered.filter(c => Array.isArray(c.skills) && filterSkills.every(fs => c.skills.includes(fs)));
    if (search) filtered = filtered.filter(c => c.name?.toLowerCase().includes(search.toLowerCase()) || c.email?.toLowerCase().includes(search.toLowerCase()));
    const toggleSkill = s => filterSkills.includes(s) ? setFilterSkills(filterSkills.filter(x => x !== s)) : setFilterSkills([...filterSkills, s]);
    return (
        <>
            <div className="topbar"><h1>Candidates</h1><div style={{display:'flex',gap:'10px'}}><button className="btn btn-secondary" onClick={onUpload}>üìÑ Upload CV</button><button className="btn btn-primary" onClick={onAdd}>+ Add</button></div></div>
            <div className="content">
                <div className="toolbar"><div className="search-box"><span className="search-icon">üîç</span><input className="search-input" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} /></div><div className="filter-group"><button className={`filter-btn ${filterType==='all'?'active':''}`} onClick={() => setFilterType('all')}>All</button><button className={`filter-btn ${filterType==='contract'?'active':''}`} onClick={() => setFilterType('contract')}>Contract</button><button className={`filter-btn ${filterType==='perm'?'active':''}`} onClick={() => setFilterType('perm')}>Perm</button></div></div>
                {topSkills.length > 0 && <div className="tag-filter-section"><div className="tag-filter-title">Filter by Skills</div><div className="tag-filters">{topSkills.map(([s,c]) => <button key={s} className={`tag-filter ${filterSkills.includes(s)?'active':''}`} onClick={() => toggleSkill(s)}>{s} <span className="count">({c})</span></button>)}{filterSkills.length > 0 && <button className="tag-filter" style={{background:'#fee',color:'#c00'}} onClick={() => setFilterSkills([])}>Clear</button>}</div></div>}
                <div style={{marginBottom:'20px',color:'#666'}}>{filtered.length} candidate{filtered.length!==1?'s':''}</div>
                {filtered.length === 0 ? <div className="empty"><div className="empty-icon">üë§</div><div className="empty-title">No candidates</div><button className="btn btn-primary" onClick={onAdd}>+ Add</button></div> : <div className="grid">{filtered.map(c => <div key={c.id} className="card" onClick={() => onSelect(c)}><div className="card-header"><div><div className="card-title">{c.name}</div><div className="card-subtitle">{c.location || c.email || ''}</div></div><span className={`tag tag-${c.type||'contract'}`}>{c.type==='perm'?'Perm':'Contract'}</span></div>{(c.dayRate||c.salary) && <div style={{marginBottom:'10px'}}>{c.dayRate && <span className="rate-box contract">¬£{c.dayRate}/day</span>}{c.salary && <span className="rate-box perm">¬£{parseInt(c.salary).toLocaleString()}</span>}</div>}{Array.isArray(c.skills) && c.skills.length > 0 && <div className="tags">{c.skills.slice(0,4).map((s,i) => <span key={i} className="tag tag-skill">{s}</span>)}{c.skills.length > 4 && <span className="tag">+{c.skills.length-4}</span>}</div>}</div>)}</div>}
            </div>
        </>
    );
}

function CandidateDetail({ candidate, activities, submissions, jobs, clients, onClose, onEdit, onDelete, onAddActivity, onAddSubmission }) {
    return (
        <div className="detail-panel">
            <div className="detail-header"><div><h2 style={{fontSize:'22px',marginBottom:'5px'}}>{candidate.name}</h2><div style={{color:'#666'}}>{candidate.email||''}</div></div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="detail-body">
                <div style={{display:'flex',gap:'10px',marginBottom:'25px',flexWrap:'wrap'}}><button className="btn btn-secondary btn-sm" onClick={onEdit}>‚úèÔ∏è Edit</button><button className="btn btn-secondary btn-sm" onClick={onAddActivity}>üìù Log</button><button className="btn btn-secondary btn-sm" onClick={onAddSubmission}>üéØ Submit</button><button className="btn btn-danger btn-sm" onClick={onDelete}>üóëÔ∏è</button></div>
                <div className="detail-section"><div className="detail-section-title">Details</div><div className="info-grid"><div className="info-item"><div className="info-label">Type</div><div className="info-value"><span className={`tag tag-${candidate.type||'contract'}`}>{candidate.type==='perm'?'Perm':'Contract'}</span></div></div><div className="info-item"><div className="info-label">Location</div><div className="info-value">{candidate.location||'-'}</div></div><div className="info-item"><div className="info-label">Phone</div><div className="info-value">{candidate.phone||'-'}</div></div><div className="info-item"><div className="info-label">{candidate.type==='perm'?'Salary':'Day Rate'}</div><div className="info-value">{candidate.dayRate && `¬£${candidate.dayRate}/day`}{candidate.salary && `¬£${parseInt(candidate.salary).toLocaleString()}`}{!candidate.dayRate && !candidate.salary && '-'}</div></div></div></div>
                {candidate.cvFileName && <div className="detail-section"><div className="detail-section-title">CV</div><div className="cv-file"><div className="cv-file-icon">üìÑ</div><div className="cv-file-info"><div className="cv-file-name">{candidate.cvFileName}</div><div className="cv-file-size">{candidate.fileSize ? Math.round(candidate.fileSize/1024)+'KB' : ''}</div></div></div></div>}
                {Array.isArray(candidate.skills) && candidate.skills.length > 0 && <div className="detail-section"><div className="detail-section-title">Skills</div><div className="tags">{candidate.skills.map((s,i) => <span key={i} className="tag tag-skill">{s}</span>)}</div></div>}
                <div className="detail-section"><div className="detail-section-title">Submissions ({submissions.length})</div>{submissions.length === 0 ? <div style={{color:'#888'}}>None</div> : submissions.map(s => { const job = jobs.find(j => j.id === s.jobId); return <div key={s.id} style={{padding:'12px',background:'#fafafa',borderRadius:'8px',marginBottom:'10px'}}><div style={{fontWeight:'600'}}>{job?.title||'Unknown'}</div><div style={{fontSize:'13px',marginTop:'4px'}}>Stage: <strong>{s.stage}</strong> ‚Ä¢ Margin: <strong>{s.margin}%</strong></div></div>; })}</div>
                <div className="detail-section"><div className="detail-section-title">Activity ({activities.length})</div>{activities.length === 0 ? <div style={{color:'#888'}}>None</div> : <div className="timeline">{activities.slice(0,10).map(a => <div key={a.id} className="timeline-item"><div className="timeline-date">{new Date(a.createdAt).toLocaleDateString()} ‚Ä¢ {a.owner||''}</div><div className="timeline-content"><strong>{a.type}</strong></div>{a.notes && <div style={{fontSize:'13px',color:'#666',marginTop:'4px'}}>{a.notes}</div>}</div>)}</div>}</div>
            </div>
        </div>
    );
}

function Jobs({ jobs, clients, search, setSearch, onAdd, onSelect }) {
    const filtered = jobs.filter(j => !search || j.title?.toLowerCase().includes(search.toLowerCase()));
    return (
        <>
            <div className="topbar"><h1>Jobs</h1><button className="btn btn-primary" onClick={onAdd}>+ Add Job</button></div>
            <div className="content">
                <div className="toolbar"><div className="search-box"><span className="search-icon">üîç</span><input className="search-input" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} /></div></div>
                {filtered.length === 0 ? <div className="empty"><div className="empty-icon">üíº</div><div className="empty-title">No jobs</div><button className="btn btn-primary" onClick={onAdd}>+ Add</button></div> : <div className="grid">{filtered.map(j => { const client = clients.find(c => c.id === j.clientId); return <div key={j.id} className="card" onClick={() => onSelect(j)}><div className="card-header"><div><div className="card-title">{j.title}</div>{client && <div className="card-subtitle">üè¢ {client.name}</div>}</div><span className={`tag ${j.status==='Open'?'tag-contract':''}`}>{j.status||'Open'}</span></div>{j.location && <div className="card-row">üìç {j.location}</div>}<div style={{marginTop:'10px'}}>{j.type==='contract' && j.rateMin && <span className="rate-box contract">¬£{j.rateMin}-¬£{j.rateMax}/day</span>}{j.type==='perm' && j.salaryMin && <span className="rate-box perm">¬£{parseInt(j.salaryMin).toLocaleString()}-¬£{parseInt(j.salaryMax).toLocaleString()}</span>}</div></div>; })}</div>}
            </div>
        </>
    );
}

function JobDetail({ job, client, submissions, candidates, onClose, onEdit, onDelete, onAddSubmission }) {
    return (
        <div className="detail-panel">
            <div className="detail-header"><div><h2 style={{fontSize:'22px',marginBottom:'5px'}}>{job.title}</h2>{client && <div style={{color:'#666'}}>üè¢ {client.name}</div>}</div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="detail-body">
                <div style={{display:'flex',gap:'10px',marginBottom:'25px'}}><button className="btn btn-secondary btn-sm" onClick={onEdit}>‚úèÔ∏è Edit</button><button className="btn btn-secondary btn-sm" onClick={onAddSubmission}>üë§ Add Candidate</button><button className="btn btn-danger btn-sm" onClick={onDelete}>üóëÔ∏è</button></div>
                <div className="detail-section"><div className="detail-section-title">Details</div><div className="info-grid"><div className="info-item"><div className="info-label">Status</div><div className="info-value"><span className="tag">{job.status}</span></div></div><div className="info-item"><div className="info-label">Type</div><div className="info-value"><span className={`tag tag-${job.type||'contract'}`}>{job.type==='perm'?'Perm':'Contract'}</span></div></div><div className="info-item"><div className="info-label">Location</div><div className="info-value">{job.location||'-'}</div></div><div className="info-item"><div className="info-label">Rate/Salary</div><div className="info-value">{job.type==='contract' && job.rateMin && `¬£${job.rateMin}-¬£${job.rateMax}/day`}{job.type==='perm' && job.salaryMin && `¬£${parseInt(job.salaryMin).toLocaleString()}-¬£${parseInt(job.salaryMax).toLocaleString()}`}{!job.rateMin && !job.salaryMin && '-'}</div></div></div></div>
                <div className="detail-section"><div className="detail-section-title">Candidates ({submissions.length})</div>{submissions.length === 0 ? <div style={{color:'#888'}}>None submitted</div> : submissions.map(s => { const cand = candidates.find(c => c.id === s.candidateId); return <div key={s.id} style={{padding:'12px',background:'#fafafa',borderRadius:'8px',marginBottom:'10px'}}><div style={{fontWeight:'600'}}>{cand?.name||'Unknown'}</div><div style={{fontSize:'13px',marginTop:'4px'}}>Stage: <strong>{s.stage}</strong> ‚Ä¢ Pay: ¬£{s.payRate} ‚Ä¢ Charge: ¬£{s.chargeRate} ‚Ä¢ Margin: <strong>{s.margin}%</strong></div></div>; })}</div>
            </div>
        </div>
    );
}

function Pipeline({ submissions, candidates, jobs, clients, onUpdateStage, onAdd }) {
    const stages = ['Sourced', 'Submitted', '1st Interview', '2nd Interview', 'Offer', 'Placed'];
    const [draggedItem, setDraggedItem] = useState(null);
    const [dragOverStage, setDragOverStage] = useState(null);
    const getColor = (sub) => { if (!sub.history?.length) return ''; const days = (Date.now() - new Date(sub.history[sub.history.length-1].date)) / (1000*60*60*24); if (days > 14) return 'red'; if (days > 7) return 'amber'; return 'green'; };
    const handleDragStart = (e, sub) => { setDraggedItem(sub); e.dataTransfer.effectAllowed = 'move'; };
    const handleDragOver = (e, stage) => { e.preventDefault(); setDragOverStage(stage); };
    const handleDragLeave = () => { setDragOverStage(null); };
    const handleDrop = (e, stage) => { e.preventDefault(); if (draggedItem && draggedItem.stage !== stage) onUpdateStage(draggedItem.id, stage); setDraggedItem(null); setDragOverStage(null); };
    const handleDragEnd = () => { setDraggedItem(null); setDragOverStage(null); };
    return (
        <>
            <div className="topbar"><h1>Pipeline</h1><button className="btn btn-primary" onClick={onAdd}>+ New Submission</button></div>
            <div className="content">
                <div className="pipeline">
                    {stages.map(stage => {
                        const items = submissions.filter(s => s.stage === stage);
                        return (
                            <div key={stage} className={`pipeline-col ${dragOverStage === stage ? 'drag-over' : ''}`} onDragOver={e => handleDragOver(e, stage)} onDragLeave={handleDragLeave} onDrop={e => handleDrop(e, stage)}>
                                <div className="pipeline-header"><span className="pipeline-title">{stage}</span><span className="pipeline-count">{items.length}</span></div>
                                {items.map(sub => {
                                    const cand = candidates.find(c => c.id === sub.candidateId);
                                    const job = jobs.find(j => j.id === sub.jobId);
                                    const client = job ? clients.find(c => c.id === job.clientId) : null;
                                    return (
                                        <div key={sub.id} className={`pipeline-card ${getColor(sub)} ${draggedItem?.id === sub.id ? 'dragging' : ''}`} draggable onDragStart={e => handleDragStart(e, sub)} onDragEnd={handleDragEnd}>
                                            <div className="pipeline-card-title">{cand?.name || 'Unknown'}</div>
                                            <div className="pipeline-card-sub">{job?.title || 'Unknown'}</div>
                                            {client && <div style={{fontSize:'11px',color:'#888',marginBottom:'8px'}}>üè¢ {client.name}</div>}
                                            <div className="pipeline-card-meta"><span className={parseFloat(sub.margin)>=20?'margin-good':parseFloat(sub.margin)>=15?'margin-ok':'margin-low'}>{sub.margin}%</span><span>¬£{sub.chargeRate}/day</span></div>
                                            <select style={{width:'100%',marginTop:'10px',padding:'8px',fontSize:'12px',border:'1px solid #e0e0e0',borderRadius:'6px',background:'#fff'}} value="" onChange={e => e.target.value && onUpdateStage(sub.id, e.target.value)}><option value="">Move to...</option>{stages.filter(s => s !== stage).map(s => <option key={s} value={s}>{s}</option>)}<option value="Rejected">‚ùå Rejected</option></select>
                                        </div>
                                    );
                                })}
                            </div>
                        );
                    })}
                </div>
            </div>
        </>
    );
}

function Clients({ clients, search, setSearch, onAdd, onEdit }) {
    const filtered = clients.filter(c => !search || c.name?.toLowerCase().includes(search.toLowerCase()));
    return (
        <>
            <div className="topbar"><h1>Clients</h1><button className="btn btn-primary" onClick={onAdd}>+ Add</button></div>
            <div className="content">
                <div className="toolbar"><div className="search-box"><span className="search-icon">üîç</span><input className="search-input" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} /></div></div>
                {filtered.length === 0 ? <div className="empty"><div className="empty-icon">üè¢</div><div className="empty-title">No clients</div><button className="btn btn-primary" onClick={onAdd}>+ Add</button></div> : <div className="grid">{filtered.map(c => <div key={c.id} className="card" onClick={() => onEdit(c)}><div className="card-title">{c.name}</div><div className="card-subtitle">{c.industry||''}</div>{c.location && <div className="card-row">üìç {c.location}</div>}</div>)}</div>}
            </div>
        </>
    );
}

function Contacts({ contacts, clients, search, setSearch, onAdd, onEdit }) {
    const filtered = contacts.filter(c => !search || c.name?.toLowerCase().includes(search.toLowerCase()));
    return (
        <>
            <div className="topbar"><h1>Contacts</h1><button className="btn btn-primary" onClick={onAdd}>+ Add</button></div>
            <div className="content">
                <div className="toolbar"><div className="search-box"><span className="search-icon">üîç</span><input className="search-input" placeholder="Search..." value={search} onChange={e => setSearch(e.target.value)} /></div></div>
                {filtered.length === 0 ? <div className="empty"><div className="empty-icon">üìá</div><div className="empty-title">No contacts</div><button className="btn btn-primary" onClick={onAdd}>+ Add</button></div> : <div className="grid">{filtered.map(c => { const client = clients.find(cl => cl.id === c.clientId); return <div key={c.id} className="card" onClick={() => onEdit(c)}><div className="card-title">{c.name}</div><div className="card-subtitle">{c.role||''}</div>{c.email && <div className="card-row">üìß {c.email}</div>}{c.phone && <div className="card-row">üì± {c.phone}</div>}{client && <div className="tags"><span className="tag tag-primary">üè¢ {client.name}</span></div>}</div>; })}</div>}
            </div>
        </>
    );
}

function Activities({ activities, candidates, contacts, jobs, onAdd }) {
    return (
        <>
            <div className="topbar"><h1>Activity Log</h1><button className="btn btn-primary" onClick={onAdd}>+ Log</button></div>
            <div className="content">
                {activities.length === 0 ? <div className="empty"><div className="empty-icon">üìù</div><div className="empty-title">No activity</div><button className="btn btn-primary" onClick={onAdd}>+ Log</button></div> : <div className="timeline">{activities.map(a => { let related = ''; if (a.relatedType === 'candidate') related = candidates.find(c => c.id === a.relatedId)?.name; if (a.relatedType === 'contact') related = contacts.find(c => c.id === a.relatedId)?.name; if (a.relatedType === 'job') related = jobs.find(j => j.id === a.relatedId)?.title; return <div key={a.id} className="timeline-item"><div className="timeline-date">{new Date(a.createdAt).toLocaleString()} ‚Ä¢ {a.owner||''}</div><div className="timeline-content"><strong>{a.type}</strong>{related && ` ‚Üí ${related}`}</div>{a.notes && <div style={{fontSize:'13px',color:'#666',marginTop:'4px'}}>{a.notes}</div>}</div>; })}</div>}
            </div>
        </>
    );
}

function CandidateModal({ item, onClose, onSave }) {
    const [form, setForm] = useState({ name: '', email: '', phone: '', location: '', type: 'contract', dayRate: '', salary: '', skills: [], owner: '', linkedin: '', ...item, skills: item?.skills || [] });
    const [skillInput, setSkillInput] = useState('');
    const [showSugg, setShowSugg] = useState(false);
    const sugg = skillInput.length > 0 ? ALL_SKILLS.filter(s => s.skill.toLowerCase().includes(skillInput.toLowerCase())).slice(0,10) : [];
    const addSkill = s => { if (!form.skills.includes(s)) setForm({ ...form, skills: [...form.skills, s] }); setSkillInput(''); setShowSugg(false); };
    const removeSkill = s => setForm({ ...form, skills: form.skills.filter(x => x !== s) });
    const submit = e => { e.preventDefault(); onSave(form); };
    return (
        <div className="modal-overlay" onClick={onClose}><div className="modal modal-lg" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">{item ? 'Edit' : 'Add'} Candidate</div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="modal-body"><form onSubmit={submit}>
                <div className="form-row"><div className="form-group"><label className="form-label">Name *</label><input className="form-input" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div><div className="form-group"><label className="form-label">Email</label><input className="form-input" type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} /></div></div>
                <div className="form-row"><div className="form-group"><label className="form-label">Phone</label><input className="form-input" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} /></div><div className="form-group"><label className="form-label">Location</label><input className="form-input" value={form.location} onChange={e => setForm({...form, location: e.target.value})} /></div></div>
                <div className="form-row"><div className="form-group"><label className="form-label">Type</label><select className="form-select" value={form.type} onChange={e => setForm({...form, type: e.target.value})}><option value="contract">Contract</option><option value="perm">Permanent</option></select></div><div className="form-group"><label className="form-label">{form.type==='perm'?'Salary (¬£)':'Day Rate (¬£)'}</label>{form.type==='contract' ? <input className="form-input" type="number" placeholder="500" value={form.dayRate} onChange={e => setForm({...form, dayRate: e.target.value})} /> : <input className="form-input" type="number" placeholder="65000" value={form.salary} onChange={e => setForm({...form, salary: e.target.value})} />}</div></div>
                <div className="form-group"><label className="form-label">Skills</label><div className="skill-input-wrap"><input className="form-input" placeholder="Type to search..." value={skillInput} onChange={e => { setSkillInput(e.target.value); setShowSugg(true); }} onFocus={() => setShowSugg(true)} />{showSugg && sugg.length > 0 && <div className="skill-suggestions">{sugg.map(s => <div key={s.skill} className="skill-suggestion" onClick={() => addSkill(s.skill)}><strong>{s.skill}</strong> <span style={{color:'#888'}}>({s.category})</span></div>)}</div>}</div>{form.skills.length > 0 && <div className="selected-skills">{form.skills.map(s => <span key={s} className="selected-skill">{s}<button type="button" onClick={() => removeSkill(s)}>√ó</button></span>)}</div>}</div>
                <div className="form-row"><div className="form-group"><label className="form-label">LinkedIn</label><input className="form-input" value={form.linkedin} onChange={e => setForm({...form, linkedin: e.target.value})} /></div><div className="form-group"><label className="form-label">Owner</label><input className="form-input" value={form.owner} onChange={e => setForm({...form, owner: e.target.value})} /></div></div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button><button type="submit" className="btn btn-primary">Save</button></div>
            </form></div>
        </div></div>
    );
}

function UploadModal({ onClose, onSave }) {
    const [dragging, setDragging] = useState(false);
    const [parsing, setParsing] = useState(false);
    const [parsed, setParsed] = useState(null);
    const [form, setForm] = useState({ name: '', email: '', phone: '', location: '', type: 'contract', dayRate: '', salary: '', skills: [], owner: '' });
    const [skillInput, setSkillInput] = useState('');
    const [showSugg, setShowSugg] = useState(false);
    const fileRef = useRef();
    const handleFile = async f => { setParsing(true); const r = await parseCV(f); setParsed(r); setForm({ ...form, name: r.name, email: r.email, phone: r.phone, location: r.location, skills: r.skills, cvFileName: r.fileName, cvFileSize: r.fileSize }); setParsing(false); };
    const sugg = skillInput.length > 0 ? ALL_SKILLS.filter(s => s.skill.toLowerCase().includes(skillInput.toLowerCase())).slice(0,10) : [];
    const addSkill = s => { if (!form.skills.includes(s)) setForm({ ...form, skills: [...form.skills, s] }); setSkillInput(''); setShowSugg(false); };
    const removeSkill = s => setForm({ ...form, skills: form.skills.filter(x => x !== s) });
    const submit = e => { e.preventDefault(); onSave(form); };
    return (
        <div className="modal-overlay" onClick={onClose}><div className="modal modal-lg" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">Upload CV</div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="modal-body">
                {!parsed ? <div className={`dropzone ${dragging?'active':''}`} onDragOver={e => { e.preventDefault(); setDragging(true); }} onDragLeave={() => setDragging(false)} onDrop={e => { e.preventDefault(); setDragging(false); handleFile(e.dataTransfer.files[0]); }} onClick={() => fileRef.current?.click()}><input type="file" ref={fileRef} hidden accept=".pdf,.docx,.doc,.txt" onChange={e => handleFile(e.target.files[0])} /><div className="dropzone-icon">{parsing?'‚è≥':'üìÑ'}</div><div className="dropzone-text">{parsing?'Parsing...':'Drop CV here or click'}</div><div className="dropzone-hint">PDF, Word, or text</div></div> : <form onSubmit={submit}>
                    <div style={{background:'#e8fff0',padding:'15px',borderRadius:'10px',marginBottom:'20px'}}>‚úì CV parsed</div>
                    <div className="cv-file"><div className="cv-file-icon">üìÑ</div><div className="cv-file-info"><div className="cv-file-name">{form.cvFileName}</div><div className="cv-file-size">{Math.round(form.cvFileSize/1024)}KB</div></div></div>
                    <div style={{marginTop:'20px'}}>
                        <div className="form-row"><div className="form-group"><label className="form-label">Name *</label><input className="form-input" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div><div className="form-group"><label className="form-label">Email</label><input className="form-input" value={form.email} onChange={e => setForm({...form, email: e.target.value})} /></div></div>
                        <div className="form-row"><div className="form-group"><label className="form-label">Phone</label><input className="form-input" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} /></div><div className="form-group"><label className="form-label">Location</label><input className="form-input" value={form.location} onChange={e => setForm({...form, location: e.target.value})} /></div></div>
                        <div className="form-row"><div className="form-group"><label className="form-label">Type</label><select className="form-select" value={form.type} onChange={e => setForm({...form, type: e.target.value})}><option value="contract">Contract</option><option value="perm">Permanent</option></select></div><div className="form-group"><label className="form-label">{form.type==='perm'?'Salary':'Day Rate'}</label><input className="form-input" type="number" value={form.type==='perm'?form.salary:form.dayRate} onChange={e => setForm({...form, [form.type==='perm'?'salary':'dayRate']: e.target.value})} /></div></div>
                        <div className="form-group"><label className="form-label">Skills</label><div className="skill-input-wrap"><input className="form-input" placeholder="Add more..." value={skillInput} onChange={e => { setSkillInput(e.target.value); setShowSugg(true); }} onFocus={() => setShowSugg(true)} />{showSugg && sugg.length > 0 && <div className="skill-suggestions">{sugg.map(s => <div key={s.skill} className="skill-suggestion" onClick={() => addSkill(s.skill)}><strong>{s.skill}</strong></div>)}</div>}</div>{form.skills.length > 0 && <div className="selected-skills">{form.skills.map(s => <span key={s} className="selected-skill">{s}<button type="button" onClick={() => removeSkill(s)}>√ó</button></span>)}</div>}</div>
                        <div className="form-group"><label className="form-label">Owner</label><input className="form-input" value={form.owner} onChange={e => setForm({...form, owner: e.target.value})} /></div>
                    </div>
                    <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={() => setParsed(null)}>Different CV</button><button type="submit" className="btn btn-primary">Save</button></div>
                </form>}
            </div>
        </div></div>
    );
}

function JobModal({ item, clients, onClose, onSave }) {
    const [form, setForm] = useState({ title: '', clientId: '', location: '', type: 'contract', rateMin: '', rateMax: '', salaryMin: '', salaryMax: '', owner: '', status: 'Open', ...item });
    const submit = e => { e.preventDefault(); onSave(form); };
    return (
        <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">{item ? 'Edit' : 'Add'} Job</div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="modal-body"><form onSubmit={submit}>
                <div className="form-group"><label className="form-label">Title *</label><input className="form-input" required value={form.title} onChange={e => setForm({...form, title: e.target.value})} /></div>
                <div className="form-row"><div className="form-group"><label className="form-label">Client</label><select className="form-select" value={form.clientId} onChange={e => setForm({...form, clientId: e.target.value})}><option value="">Select...</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div><div className="form-group"><label className="form-label">Location</label><input className="form-input" value={form.location} onChange={e => setForm({...form, location: e.target.value})} /></div></div>
                <div className="form-row"><div className="form-group"><label className="form-label">Type</label><select className="form-select" value={form.type} onChange={e => setForm({...form, type: e.target.value})}><option value="contract">Contract</option><option value="perm">Permanent</option></select></div><div className="form-group"><label className="form-label">Status</label><select className="form-select" value={form.status} onChange={e => setForm({...form, status: e.target.value})}><option>Open</option><option>Hold</option><option>Closed</option></select></div></div>
                {form.type==='contract' ? <div className="form-row"><div className="form-group"><label className="form-label">Min Rate</label><input className="form-input" type="number" value={form.rateMin} onChange={e => setForm({...form, rateMin: e.target.value})} /></div><div className="form-group"><label className="form-label">Max Rate</label><input className="form-input" type="number" value={form.rateMax} onChange={e => setForm({...form, rateMax: e.target.value})} /></div></div> : <div className="form-row"><div className="form-group"><label className="form-label">Min Salary</label><input className="form-input" type="number" value={form.salaryMin} onChange={e => setForm({...form, salaryMin: e.target.value})} /></div><div className="form-group"><label className="form-label">Max Salary</label><input className="form-input" type="number" value={form.salaryMax} onChange={e => setForm({...form, salaryMax: e.target.value})} /></div></div>}
                <div className="form-group"><label className="form-label">Owner</label><input className="form-input" value={form.owner} onChange={e => setForm({...form, owner: e.target.value})} /></div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button><button type="submit" className="btn btn-primary">Save</button></div>
            </form></div>
        </div></div>
    );
}

function ClientModal({ item, onClose, onSave }) {
    const [form, setForm] = useState({ name: '', industry: '', location: '', website: '', ...item });
    const submit = e => { e.preventDefault(); onSave(form); };
    return (
        <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">{item ? 'Edit' : 'Add'} Client</div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="modal-body"><form onSubmit={submit}>
                <div className="form-group"><label className="form-label">Name *</label><input className="form-input" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div>
                <div className="form-group"><label className="form-label">Industry</label><input className="form-input" value={form.industry} onChange={e => setForm({...form, industry: e.target.value})} /></div>
                <div className="form-row"><div className="form-group"><label className="form-label">Location</label><input className="form-input" value={form.location} onChange={e => setForm({...form, location: e.target.value})} /></div><div className="form-group"><label className="form-label">Website</label><input className="form-input" value={form.website} onChange={e => setForm({...form, website: e.target.value})} /></div></div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button><button type="submit" className="btn btn-primary">Save</button></div>
            </form></div>
        </div></div>
    );
}

function ContactModal({ item, clients, onClose, onSave }) {
    const [form, setForm] = useState({ name: '', role: '', email: '', phone: '', clientId: '', ...item });
    const submit = e => { e.preventDefault(); onSave(form); };
    return (
        <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">{item ? 'Edit' : 'Add'} Contact</div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="modal-body"><form onSubmit={submit}>
                <div className="form-row"><div className="form-group"><label className="form-label">Name *</label><input className="form-input" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} /></div><div className="form-group"><label className="form-label">Role</label><input className="form-input" value={form.role} onChange={e => setForm({...form, role: e.target.value})} /></div></div>
                <div className="form-row"><div className="form-group"><label className="form-label">Email</label><input className="form-input" type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} /></div><div className="form-group"><label className="form-label">Phone</label><input className="form-input" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} /></div></div>
                <div className="form-group"><label className="form-label">Client</label><select className="form-select" value={form.clientId} onChange={e => setForm({...form, clientId: e.target.value})}><option value="">Select...</option>{clients.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button><button type="submit" className="btn btn-primary">Save</button></div>
            </form></div>
        </div></div>
    );
}

function SubmissionModal({ item, candidates, jobs, onClose, onSave }) {
    const [form, setForm] = useState({ candidateId: '', jobId: '', payRate: '', chargeRate: '', ...item });
    const margin = form.chargeRate && form.payRate ? (((parseFloat(form.chargeRate) - parseFloat(form.payRate)) / parseFloat(form.chargeRate)) * 100).toFixed(1) : 0;
    const submit = e => { e.preventDefault(); onSave(form); };
    return (
        <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">{item?.id ? 'Edit' : 'New'} Submission</div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="modal-body"><form onSubmit={submit}>
                <div className="form-group"><label className="form-label">Candidate *</label><select className="form-select" required value={form.candidateId} onChange={e => setForm({...form, candidateId: e.target.value})}><option value="">Select...</option>{candidates.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div>
                <div className="form-group"><label className="form-label">Job *</label><select className="form-select" required value={form.jobId} onChange={e => setForm({...form, jobId: e.target.value})}><option value="">Select...</option>{jobs.filter(j => j.status !== 'Closed').map(j => <option key={j.id} value={j.id}>{j.title}</option>)}</select></div>
                <div className="form-row"><div className="form-group"><label className="form-label">Pay Rate *</label><input className="form-input" type="number" required placeholder="Candidate pay" value={form.payRate} onChange={e => setForm({...form, payRate: e.target.value})} /></div><div className="form-group"><label className="form-label">Charge Rate *</label><input className="form-input" type="number" required placeholder="Client charge" value={form.chargeRate} onChange={e => setForm({...form, chargeRate: e.target.value})} /></div></div>
                {form.payRate && form.chargeRate && <div style={{padding:'20px',background:parseFloat(margin)>=20?'#e8fff0':parseFloat(margin)>=15?'#fffce8':'#ffe8e8',borderRadius:'12px',textAlign:'center',marginBottom:'20px'}}><div style={{fontSize:'32px',fontWeight:'700'}}>{margin}%</div><div style={{color:'#666'}}>Margin (¬£{(parseFloat(form.chargeRate)-parseFloat(form.payRate)).toFixed(0)}/day)</div></div>}
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button><button type="submit" className="btn btn-primary">Save</button></div>
            </form></div>
        </div></div>
    );
}

function ActivityModal({ item, candidates, contacts, jobs, onClose, onSave }) {
    const [form, setForm] = useState({ type: 'Call', relatedType: 'candidate', relatedId: '', owner: '', notes: '', ...item });
    let options = form.relatedType === 'candidate' ? candidates : form.relatedType === 'contact' ? contacts : jobs;
    const submit = e => { e.preventDefault(); onSave(form); };
    return (
        <div className="modal-overlay" onClick={onClose}><div className="modal" onClick={e => e.stopPropagation()}>
            <div className="modal-header"><div className="modal-title">Log Activity</div><button className="modal-close" onClick={onClose}>√ó</button></div>
            <div className="modal-body"><form onSubmit={submit}>
                <div className="form-group"><label className="form-label">Type</label><select className="form-select" value={form.type} onChange={e => setForm({...form, type: e.target.value})}><option>Call</option><option>Email</option><option>Meeting</option><option>LinkedIn</option><option>CV Sent</option><option>Interview</option><option>Note</option></select></div>
                <div className="form-row"><div className="form-group"><label className="form-label">Related To</label><select className="form-select" value={form.relatedType} onChange={e => setForm({...form, relatedType: e.target.value, relatedId: ''})}><option value="candidate">Candidate</option><option value="contact">Contact</option><option value="job">Job</option></select></div><div className="form-group"><label className="form-label">Select</label><select className="form-select" value={form.relatedId} onChange={e => setForm({...form, relatedId: e.target.value})}><option value="">Select...</option>{options.map(o => <option key={o.id} value={o.id}>{o.name||o.title}</option>)}</select></div></div>
                <div className="form-group"><label className="form-label">Owner</label><input className="form-input" placeholder="Your name" value={form.owner} onChange={e => setForm({...form, owner: e.target.value})} /></div>
                <div className="form-group"><label className="form-label">Notes</label><textarea className="form-textarea" placeholder="Details..." value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} /></div>
                <div className="modal-footer"><button type="button" className="btn btn-secondary" onClick={onClose}>Cancel</button><button type="submit" className="btn btn-primary">Save</button></div>
            </form></div>
        </div></div>
    );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
